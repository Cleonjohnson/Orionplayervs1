name: Deploy to Render

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: Trigger Render Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Trigger deploy on Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "RENDER_API_KEY and RENDER_SERVICE_ID must be set as GitHub Secrets."
            exit 1
          fi
          echo "Creating deploy for service $RENDER_SERVICE_ID ..."
          CREATE_RESPONSE=$(curl -s -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -d '{}' )
          echo "Create response: $CREATE_RESPONSE"
          DEPLOY_ID=$(echo "$CREATE_RESPONSE" | jq -r '.id // .deployId // empty')
          if [ -z "$DEPLOY_ID" ] || [ "$DEPLOY_ID" = "null" ]; then
            echo "Failed to create deploy. Response:"
            echo "$CREATE_RESPONSE"
            exit 1
          fi
          echo "Deploy created: $DEPLOY_ID"

          # Poll deploy status
          echo "Polling deploy status..."
          MAX_WAIT=600
          INTERVAL=6
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS_RESPONSE=$(curl -s -X GET "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys/${DEPLOY_ID}" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              -H "Accept: application/json")
            echo "Status response: $STATUS_RESPONSE"
            STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.status // .state // empty')
            echo "Current status: $STATUS"
            if [ "$STATUS" = "live" ] || [ "$STATUS" = "succeeded" ] || [ "$STATUS" = "success" ]; then
              echo "Deploy succeeded."
              exit 0
            fi
            if [ "$STATUS" = "failed" ] || [ "$STATUS" = "error" ]; then
              echo "Deploy failed. See Render logs."
              exit 1
            fi
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          echo "Timed out waiting for deploy to complete."
          exit 2

